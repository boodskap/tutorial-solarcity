{"type":2,"data":{"lang":"GROOVY","code":"log.trace(msg.toString());\n\ndef ID_HISTORY_RECORD = 1000;\ndef ID_COMMUNITY_RECORD = 2000;\ndef ID_HOUSEHOLD_RECORD = 2001;\ndef ID_DEVICE_RECORD = 2003;\n\n//Fetch the device record\ndef drec = record.get(ID_DEVICE_RECORD, msg.deviceid);\n\nif(null == drec){\n    log.warn('Unconfigured device %s, ignoring %s', msg.deviceid, msg);\n    return;\n}\n\n//Fetch the community record\ndef crec = record.get(ID_COMMUNITY_RECORD, drec.community);\n//Fetch the household record\ndef hrec = record.get(ID_HOUSEHOLD_RECORD, drec.household);\n\n\n\nif(null == crec){\n    log.error('Community for device:%s not found', msg.deviceid);\n    return;\n}\n\nif(null == hrec){\n    log.error('Household for community:%s, device:%s not found', drec.community, msg.deviceid);\n    return;\n}\n\nif(null != old){\n    \n    if(null != old.consumed && (old.consumed > msg.consumed)) log.warn(\"Faulty device, dld consumed:%sW is greater than new:%sW\", old.consumed, msg.consumed);\n\n    if(null != old.generated && (old.generated > msg.generated)) log.warn(\"Faulty device, old generated:%sW is greater than new:%sW\", old.generated, msg.generated);\n    \n}\n\nif(msg.consumed > msg.generated){\n    log.warn('Faulty device, consumed %fW is greated than generated %fW', msg.consumed, msg.generated);\n}\n\ndef rec = [:];\n\nrec.stamp = util.millis();\nrec.device = drec.label;\nrec.device_id = msg.deviceid;\nrec.totalconsumed = msg.consumed;\nrec.totalgenerated = msg.generated;\nrec.totaldistributed = (msg.generated - msg.consumed);\nrec.gridloss = drec.gridloss;\n\nrec.community = crec.label;\nrec.community_id = drec.community;\nrec.household = hrec.label;\nrec.household_id = drec.household;\nrec.city = crec.city;\nrec.country = crec.country;\nrec.state = crec.state;\nrec.zipcode = crec.zipcode;\n\nrecord.insert(ID_HISTORY_RECORD, rec); //insert new record to history\n\n //push into queue for status processing by StatisticsUpdaterJob\ngrid.mapQueue('POWER_STATS_Q').offer(rec);\n\n","messageId":100}}